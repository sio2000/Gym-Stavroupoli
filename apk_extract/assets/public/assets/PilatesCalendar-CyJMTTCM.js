import{d as oe,s as I,u as ne,r as p,j as e,t as le,b as ie,o as K,D as $,F as h,e as H}from"./index-CPD3QOvx.js";import{s as ce,a as de,c as me,d as xe,e as ge,f as ue}from"./pilatesScheduleApi-C-m4ljwe.js";import{g as pe,t as q,a as he,p as V}from"./date-D_3Ba85T.js";import{C as X,a as Y}from"./chevron-right-C5Of-bgN.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=oe("Wallet",[["path",{d:"M21 12V7H5a2 2 0 0 1 0-4h14v4",key:"195gfw"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h16v-5",key:"195n9w"}],["path",{d:"M18 12a2 2 0 0 0 0 4h4v-4Z",key:"vllfpd"}]]),fe=async()=>{var a;try{const{data:{user:n}}=await I.auth.getUser();if(!n)throw new Error("User not authenticated");const{data:c,error:m}=await I.rpc("get_user_weekly_refill_status",{p_user_id:n.id});if(m)throw console.error("[UltimateWeeklyDepositAPI] Error fetching refill status:",m),m;const o=(c==null?void 0:c[0])||null,{data:d,error:g}=await I.from("pilates_deposits").select("deposit_remaining, is_active").eq("user_id",n.id).eq("is_active",!0).order("credited_at",{ascending:!1}).limit(1);if(g)throw console.error("[UltimateWeeklyDepositAPI] Error fetching deposit:",g),g;const b=((a=d==null?void 0:d[0])==null?void 0:a.deposit_remaining)||0;if(!o)return{current_deposit:b,weekly_allocation:0,next_refill_date:"",refill_week:0,total_weeks_remaining:0,can_book_from_date:"",is_ultimate_user:!1};const f=new Date(o.activation_date),i=new Date,k=new Date(o.next_refill_date),z=52,W=Math.floor((i.getTime()-f.getTime())/(7*24*60*60*1e3)),w=Math.max(0,z-W),U=Math.floor((i.getTime()-f.getTime())/(24*60*60*1e3)),B=(Math.floor(U/7)+1)*7;k.setTime(f.getTime()+B*24*60*60*1e3);const C=new Date(k);C.setDate(k.getDate()+1);const L=o.target_deposit_amount>0?o.target_deposit_amount:o.package_name==="Ultimate"?3:1;return{current_deposit:b,weekly_allocation:L,next_refill_date:k.toISOString().split("T")[0],refill_week:o.next_refill_week,total_weeks_remaining:w,can_book_from_date:C.toISOString().split("T")[0],current_week_start:o.current_week_start||"",current_week_end:o.current_week_end||"",is_ultimate_user:!0,package_name:o.package_name}}catch(n){return console.error("[UltimateWeeklyDepositAPI] Error in getUltimateWeeklyDepositInfo:",n),null}},ye=a=>{if(!a.is_ultimate_user)return`${a.current_deposit} μαθήματα απομένουν`;const n=new Date,c=new Date(a.next_refill_date),m=Math.ceil((c.getTime()-n.getTime())/(24*60*60*1e3)),o=Math.ceil(m/7);return o===1?`${a.current_deposit} μαθήματα απομένουν για την τρέχουσα εβδομάδα`:`${a.current_deposit} μαθήματα απομένουν για ${o} εβδομάδες`},je=a=>{if(!a.is_ultimate_user)return"";const n=new Date(a.next_refill_date).toLocaleDateString("el-GR"),c=new Date(a.can_book_from_date).toLocaleDateString("el-GR");return`Επόμενη ανανέωση: ${n} | Κλείσιμο μαθημάτων από: ${c}`},we=()=>{const a=new Date;console.log("=== DEBUG WEEKLY LOGIC ==="),console.log("Today:",a.toLocaleDateString("el-GR")),console.log("Today day of week:",a.getDay()),console.log("Today day name:",["Κυριακή","Δευτέρα","Τρίτη","Τετάρτη","Πέμπτη","Παρασκευή","Σάββατο"][a.getDay()]);const n=new Date(a);console.log("Activation date:",n.toLocaleDateString("el-GR"));const c=Math.floor((a.getTime()-n.getTime())/(24*60*60*1e3)),m=Math.floor(c/7),o=(m+1)*7;console.log("Days since activation:",c),console.log("Weeks since activation:",m),console.log("Next refill in days:",o);const d=new Date(n);d.setDate(n.getDate()+o),console.log("Next refill date:",d.toLocaleDateString("el-GR"));const g=Math.ceil((d.getTime()-a.getTime())/(24*60*60*1e3)),b=Math.ceil(g/7);console.log("Days until refill:",g),console.log("Weeks until refill:",b);const f=new Date(d);f.setDate(d.getDate()+1),console.log("Can book from:",f.toLocaleDateString("el-GR")),console.log("=== END DEBUG ===")},De=()=>{var O;const{user:a}=ne(),[n,c]=p.useState([]),[m,o]=p.useState([]),[d,g]=p.useState(!0),[b,f]=p.useState(0),[i,k]=p.useState(null),[z,W]=p.useState(!1),[w,U]=p.useState(null),[S,B]=p.useState(()=>{const t=pe();return console.log("🔥🔥🔥 USER FORCE REFRESH: Using NEW Greek Monday function - Monday:",t.toISOString(),"TIMESTAMP:",Date.now()),console.log("🔥🔥🔥 USER FORCE REFRESH: Day of week (should be 1 for Monday):",t.getUTCDay()),t}),C=()=>{const t=[],s=new Date(S);console.log("User: getWeekDates - currentWeek:",s);for(let r=0;r<14;r++){const y=he(s,r),u=q(y);t.push(u),console.log(`User: Day ${r}: ${u}`)}return t},L=()=>{const t=[];for(let s=8;s<=21;s++)t.push(`${s.toString().padStart(2,"0")}:00`);return t},E=t=>{const s=V(t),r=["Κυρ","Δευ","Τρι","Τετ","Πεμ","Παρ","Σαβ"],y=["Ιαν","Φεβ","Μαρ","Απρ","Μαι","Ιουν","Ιουλ","Αυγ","Σεπ","Οκτ","Νοε","Δεκ"],u=r[s.getDay()],N=s.getDate(),l=y[s.getMonth()];return`${u} ${N} ${l}`},Z=t=>{const r=V(t).getDay();return r===0||r===6},J=(t,s)=>n.filter(r=>r.date===t&&r.start_time===s+":00"),Q=(t,s)=>n.some(r=>r.date===t&&r.start_time===s+":00"),F=t=>m.some(s=>s.slot_id===t&&s.status==="confirmed"),A=async()=>{if(a!=null&&a.id)try{g(!0),console.log("=== LOADING PILATES CALENDAR DATA ===");const t=C(),s=t[0],r=t[13],[y,u,N,l]=await Promise.all([de(s,r),me(a.id),xe(a.id),fe()]);console.log("Fetched slots from DB:",y.length),console.log("Fetched bookings from DB:",u.length),console.log("Weekly deposit info:",l),l!=null&&l.is_ultimate_user&&we();const j=y.map(x=>({...x,available_capacity:Math.max(0,x.max_capacity-x.booked_count)}));c(j),o(u),f((N==null?void 0:N.deposit_remaining)||0),k(l)}catch(t){console.error("Error loading data:",t),h.error("Σφάλμα φόρτωσης δεδομένων")}finally{g(!1)}},M=t=>{const s=new Date(S);t==="prev"?s.setDate(s.getDate()-14):s.setDate(s.getDate()+14),B(s),console.log("Navigated to week:",s)},ee=async t=>{if(a!=null&&a.id){if(!t.is_active){h.error("Αυτό το μάθημα δεν είναι διαθέσιμο.");return}if(F(t.id)){h.error("Έχετε ήδη κλείσει αυτό το μάθημα.");return}try{if(console.log("Booking slot:",t),b<=0){h.error("Τα μαθήματά σας τελείωσαν. Για ανανέωση, απευθυνθείτε στη ρεσεψιόν.");return}if(t.booked_count>=t.max_capacity){h.error("Το μάθημα είναι πλήρες.");return}const s=await ue({slotId:t.id,notes:""},a.id);console.log("Booking created:",s),h.success("Το μάθημα κλείστηκε επιτυχώς!"),await A()}catch(s){console.error("Error booking slot:",s),h.error("Σφάλμα κατά την κράτηση του μαθήματος.")}}},te=async t=>{if(a!=null&&a.id)try{console.log("Cancelling booking for slot:",t),await ge(t),h.success("Η κράτηση ακυρώθηκε επιτυχώς!"),await A()}catch(s){console.error("Error cancelling booking:",s),h.error("Σφάλμα κατά την ακύρωση της κράτησης.")}};p.useEffect(()=>{console.log("User: useEffect triggered - currentWeek changed to:",S.toISOString()),A();const t=ce(()=>{console.log("🔥🔥🔥 USER: Realtime update received - reloading data"),A()});return()=>{try{t.unsubscribe()}catch{}}},[a==null?void 0:a.id,S]);const _=C(),se=L(),G=q(new Date),ae=t=>{U(t),W(!0)},P=()=>{W(!1),U(null)},re=async()=>{w&&(await ee(w),P())};return d?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(le,{className:"animate-spin text-primary mx-auto mb-4",size:48}),e.jsx("p",{className:"text-lg text-gray-600",children:"Φόρτωση προγράμματος..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"container mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 sm:p-5 md:p-6 mb-4 md:mb-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-0 mb-3 md:mb-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800 flex items-center flex-wrap",children:[e.jsx(ie,{className:"mr-2 sm:mr-3 text-primary",size:28}),"Ημερολόγιο Pilates",e.jsx(K,{className:"ml-2 sm:ml-3 text-amber-500",size:20})]}),e.jsx("p",{className:"text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base",children:"Κλείστε μαθήματα pilates για τις επόμενες 2 εβδομάδες"})]})}),e.jsxs("div",{className:"hidden sm:grid grid-cols-[auto,1fr,auto] items-center gap-1.5 sm:gap-3 mb-3 sm:mb-4",children:[e.jsx("div",{className:"flex items-center gap-1.5 py-1 min-w-0",children:e.jsxs("button",{onClick:()=>M("prev"),className:"flex items-center px-2 sm:px-3 py-1.5 sm:py-2 text-[12px] sm:text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors whitespace-nowrap",children:[e.jsx(X,{size:16,className:"mr-1.5"}),"Προηγούμενη"]})}),e.jsx("div",{className:"text-center min-w-0",children:e.jsxs("h2",{className:"text-xs sm:text-xl font-semibold text-gray-800 truncate",children:["2 εβδομάδες: ",E(_[0])," - ",E(_[13])]})}),e.jsxs("button",{onClick:()=>M("next"),className:"flex items-center px-2 sm:px-3 py-1.5 sm:py-2 text-[12px] sm:text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors whitespace-nowrap",children:["Επόμενη",e.jsx(Y,{size:16,className:"ml-1.5"})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4 mb-4 md:mb-6",children:e.jsxs("p",{className:"text-blue-800 text-xs sm:text-sm leading-relaxed",children:[e.jsx("strong",{children:"Οδηγίες:"})," Κάντε κλικ στα πράσινα μαθήματα για να κλείσετε κράτηση. Τα κόκκινα μαθήματα είναι ακυρωμένα από τον admin. Τα μπλε μαθήματα είναι ήδη κρατημένα από εσάς."]})}),e.jsxs("div",{className:"rounded-xl p-4 sm:p-5 mb-4 border bg-gradient-to-r from-pink-50 to-rose-50 border-rose-200",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"mr-3 inline-flex h-9 w-9 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-white border border-rose-200 shadow-sm",children:e.jsx(be,{className:"text-rose-500",size:18})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs sm:text-sm text-rose-700",children:"Υπόλοιπο Pilates"}),e.jsx("p",{className:"text-lg sm:text-xl font-bold text-rose-800",children:i?ye(i):`${b} μαθήματα απομένουν`})]})]}),e.jsxs("span",{className:"shrink-0 inline-flex items-center rounded-full bg-white text-rose-700 border border-rose-200 px-2.5 sm:px-3 py-1 text-[11px] sm:text-xs font-semibold shadow-sm",children:[e.jsx(K,{className:"mr-1",size:12}),i!=null&&i.is_ultimate_user?"Ultimate":"Κράτα το ρυθμό!"]})]}),(i==null?void 0:i.is_ultimate_user)&&e.jsxs("div",{className:"mt-3 p-3 bg-white/50 rounded-lg border border-rose-100",children:[e.jsx("p",{className:"text-xs text-rose-600 font-medium",children:je(i)}),e.jsxs("p",{className:"text-xs text-rose-500 mt-1",children:["Εβδομαδιαία ανανέωση: ",i.weekly_allocation," μαθήματα | Εβδομάδες που απομένουν: ",i.total_weeks_remaining]})]}),b<=0&&e.jsx("p",{className:"text-red-600 mt-3 text-xs sm:text-sm",children:"Τα μαθήματά σας τελείωσαν. Για ανανέωση, απευθυνθείτε στη ρεσεψιόν."})]})]}),e.jsxs("div",{className:"sm:hidden mb-3",children:[e.jsx("div",{className:"text-center mb-2",children:e.jsxs("div",{className:"inline-block px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-semibold",children:["2 εβδομάδες: ",E(_[0])," - ",E(_[13])]})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("button",{onClick:()=>M("prev"),className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-lg shadow-sm hover:bg-blue-700 active:scale-[0.99]","aria-label":"Προηγούμενη εβδομάδα",children:[e.jsx(X,{size:16}),"Προηγούμενη"]}),e.jsxs("button",{onClick:()=>M("next"),className:"flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-lg shadow-sm hover:bg-blue-700 active:scale-[0.99]","aria-label":"Επόμενη εβδομάδα",children:["Επόμενη",e.jsx(Y,{size:16})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"sm:hidden text-xs text-gray-500 px-3 pt-3",children:"Σύρετε οριζόντια για να δείτε όλες τις ημέρες"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-[10px] sm:text-xs md:text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b sticky top-0 z-20",children:[e.jsx("th",{className:"px-3 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700 w-16 sm:w-20 sticky left-0 bg-gray-50 z-30 border-r border-gray-200",children:"Ώρα"}),_.map(t=>{const s=t===G;return e.jsxs("th",{className:`px-3 sm:px-4 py-2 sm:py-3 text-center font-semibold min-w-[5.25rem] sm:min-w-32 relative ${s?"bg-gradient-to-br from-orange-400 via-pink-500 to-purple-600 text-white shadow-lg animate-pulse":"text-gray-700 bg-gray-50"}`,title:s?"Σήμερα":void 0,children:[s&&e.jsx("div",{className:"absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg animate-bounce",children:e.jsx("span",{className:"text-xs",children:"🔥"})}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`${s?"text-white font-bold":"text-gray-700"}`,children:E(t)}),s&&e.jsxs("div",{className:"mt-1 flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs",children:"💪"}),e.jsx("span",{className:"inline-block px-2 py-0.5 text-[9px] sm:text-[10px] rounded-full bg-white/20 text-white font-bold animate-pulse",children:"ΣΗΜΕΡΑ"}),e.jsx("span",{className:"text-xs",children:"🏋️‍♀️"})]})]})]},t)})]})}),e.jsx("tbody",{children:se.map(t=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 sm:px-4 py-2 sm:py-3 font-medium text-gray-700 sticky left-0 bg-white z-10 border-r border-gray-100",children:t}),_.map(s=>{const r=J(s,t),y=Z(s),u=Q(s,t),N=s===G;return e.jsx("td",{className:`px-2.5 sm:px-4 py-1.5 sm:py-3 text-center align-middle relative ${N?"bg-gradient-to-r from-orange-50/60 via-pink-50/60 to-purple-50/60 border-l-2 border-orange-400":""}`,children:y?e.jsx("div",{className:"text-gray-400 text-[10px] sm:text-xs",children:"Σαβ/Κυρ"}):u?e.jsx("div",{className:"space-y-1",children:r.map(l=>{const j=F(l.id),x=l.is_active,D=l.booked_count>=l.max_capacity;let R="",T=null,v="";return j?(R="bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200",T=e.jsx(H,{size:12,className:"text-blue-600"}),v="Κρατημένο"):x&&!D?(R="bg-green-100 text-green-800 border-green-200 hover:bg-green-200 cursor-pointer",T=e.jsx(H,{size:12,className:"text-green-600"}),v=`${l.booked_count}/${l.max_capacity}`):x&&D?(R="bg-rose-50 text-rose-700 border-rose-200 cursor-not-allowed",T=e.jsx($,{size:12,className:"text-rose-600"}),v="Πλήρες"):(R="bg-rose-50 text-rose-700 border-rose-200 cursor-not-allowed",T=e.jsx($,{size:12,className:"text-rose-600"}),v="Ακυρωμένο"),e.jsx("button",{type:"button","aria-label":j?"Ακύρωση κράτησης":x&&!D?"Κλείσιμο μαθήματος":v,title:j?"Κάντε κλικ για ακύρωση":x&&!D?"Κάντε κλικ για κράτηση":v,className:`px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg border text-[10px] sm:text-xs font-medium transition-colors transition-transform focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-300 ${R} ${x&&!j&&!D?"hover:scale-[1.02]":""}`,onClick:()=>{x&&!j&&!D?ae(l):j&&te(l.id)},children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[T,e.jsx("span",{children:v})]})},l.id)})}):e.jsx("div",{className:"bg-red-100 text-red-800 border-red-200 px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg text-[10px] sm:text-xs font-medium cursor-not-allowed",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx($,{size:12,className:"text-red-600"}),e.jsx("span",{children:"Μη διαθέσιμο"})]})})},`${s}-${t}`)})]},t))})]})})]}),e.jsxs("div",{className:"mt-6 bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Εξήγηση χρωμάτων"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-green-100 border border-green-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Διαθέσιμο για κράτηση"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-100 border border-blue-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Κρατημένο από εσάς"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-rose-50 border border-rose-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Πλήρες/Ακυρωμένο"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-neutral-100 border border-neutral-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Μη διαθέσιμο"})]})]})]}),z&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end sm:items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title","aria-describedby":"confirm-desc",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:P}),e.jsxs("div",{className:"relative bg-white w-full sm:w-[90%] max-w-md rounded-t-2xl sm:rounded-xl shadow-lg border p-5 sm:p-6 animate-in fade-in slide-in-from-bottom-4 sm:zoom-in",children:[e.jsxs("h4",{id:"confirm-title",className:"text-base sm:text-lg font-semibold text-gray-800 flex items-center",children:[e.jsx($,{size:18,className:"text-rose-600 mr-2"})," Επιβεβαίωση κράτησης"]}),e.jsx("p",{id:"confirm-desc",className:"text-sm text-gray-700 mt-2 sm:mt-3",children:"Αν προχωρήσετε σε κράτηση, δεν θα μπορείτε να ακυρώσετε το μάθημα μετά."}),w&&e.jsxs("div",{className:"mt-3 sm:mt-4 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium text-gray-800",children:"Ημερομηνία:"})," ",w.date,e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{className:"font-medium text-gray-800",children:"Ώρα:"})," ",(O=w.start_time)==null?void 0:O.slice(0,5)]}),e.jsxs("div",{className:"mt-5 sm:mt-6 flex items-center justify-end gap-2 sm:gap-3",children:[e.jsx("button",{type:"button",onClick:P,className:"px-3 sm:px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:"Ακύρωση"}),e.jsx("button",{type:"button",onClick:re,className:"px-3 sm:px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition-colors",children:"Επιβεβαίωση"})]})]})]})]})})};export{De as default};
