import{u as O,r as p,s as m,z as c,j as e,e as T,h as U,n as q,b as N,C as w,U as P,D as k,w as K}from"./index-20cc1d6t.js";import{B as M}from"./book-open-DgoM-XmK.js";import{Z as F}from"./zap-DkcEm6Vf.js";const z=()=>{const{user:a}=O(),[g,v]=p.useState(null),[i,D]=p.useState(null),[x,E]=p.useState([]),[j,I]=p.useState([]),[S,y]=p.useState(!0),[h,f]=p.useState(null),L=["Κυριακή","Δευτέρα","Τρίτη","Τετάρτη","Πέμπτη","Παρασκευή","Σάββατο"];p.useEffect(()=>{a!=null&&a.id&&b()},[a==null?void 0:a.id]);const b=async()=>{try{console.log("[PaspartuTraining] ===== LOADING PASPARTU DATA ====="),console.log("[PaspartuTraining] User ID:",a==null?void 0:a.id),y(!0),console.log("[PaspartuTraining] Querying personal_training_schedules...");const{data:s,error:l}=await m.from("personal_training_schedules").select("*").eq("user_id",a==null?void 0:a.id).order("created_at",{ascending:!1});if(console.log("[PaspartuTraining] All schedules for user:",s),console.log("[PaspartuTraining] All schedules error:",l),s&&s.length>0){console.log("[PaspartuTraining] Found schedules, checking for Paspartu...");const r=s.find(n=>n.user_type==="paspartu"&&n.is_flexible===!0);if(r){console.log("[PaspartuTraining] Found Paspartu schedule:",r);const n={id:r.id,userId:r.user_id,month:r.month,year:r.year,scheduleData:r.schedule_data,status:r.status,createdBy:r.created_by,createdAt:r.created_at,updatedAt:r.updated_at,acceptedAt:r.accepted_at,declinedAt:r.declined_at,userType:r.user_type,isFlexible:r.is_flexible};v(n)}else console.log("[PaspartuTraining] No Paspartu schedule found in user schedules"),s.forEach((n,R)=>{console.log(`[PaspartuTraining] Schedule ${R}:`,{id:n.id,user_type:n.user_type,is_flexible:n.is_flexible,status:n.status})})}else console.log("[PaspartuTraining] No schedules found for user");console.log("[PaspartuTraining] Querying lesson_deposits...");const{data:o,error:d}=await m.from("lesson_deposits").select("*").eq("user_id",a==null?void 0:a.id).single();if(console.log("[PaspartuTraining] Deposit data:",o),console.log("[PaspartuTraining] Deposit error:",d),d)console.error("Error loading lesson deposit:",d);else if(o){const r={id:o.id,userId:o.user_id,totalLessons:o.total_lessons,usedLessons:o.used_lessons,remainingLessons:o.remaining_lessons,createdAt:o.created_at,updatedAt:o.updated_at,createdBy:o.created_by};console.log("[PaspartuTraining] Setting deposit:",r),D(r)}console.log("[PaspartuTraining] Querying lesson_bookings...");const{data:t,error:u}=await m.from("lesson_bookings").select("*").eq("user_id",a==null?void 0:a.id).order("booking_date",{ascending:!0});if(console.log("[PaspartuTraining] Bookings data:",t),console.log("[PaspartuTraining] Bookings error:",u),u)console.error("Error loading lesson bookings:",u);else if(t){const r=t.map(n=>({id:n.id,userId:n.user_id,scheduleId:n.schedule_id,sessionId:n.session_id,bookingDate:n.booking_date,bookingTime:n.booking_time,trainerName:n.trainer_name,room:n.room,notes:n.notes,status:n.status,createdAt:n.created_at,updatedAt:n.updated_at}));console.log("[PaspartuTraining] Setting bookings:",r),E(r)}}catch(s){console.error("Error loading Paspartu data:",s),c.error("Σφάλμα κατά τη φόρτωση των δεδομένων")}finally{y(!1)}},A=s=>{var d;if(!((d=s==null?void 0:s.scheduleData)!=null&&d.sessions))return[];const l=[],o=new Set(x.map(t=>t.sessionId));return s.scheduleData.sessions.forEach(t=>{const u=o.has(t.id),r=x.find(n=>n.sessionId===t.id);l.push({sessionId:t.id,date:t.date,startTime:t.startTime,endTime:t.endTime,type:t.type,trainer:t.trainer,room:t.room,isBooked:u,bookingId:r==null?void 0:r.id})}),l.sort((t,u)=>new Date(t.date).getTime()-new Date(u.date).getTime())};p.useEffect(()=>{if(g){const s=A(g);I(s)}},[g,x]);const B=async s=>{if(console.log("[PaspartuTraining] ===== HANDLING CANCEL LESSON ====="),console.log("[PaspartuTraining] Booking ID:",s),console.log("[PaspartuTraining] Deposit BEFORE cancellation:",i),!i){console.log("[PaspartuTraining] No deposit found"),c.error("Δεν βρέθηκε deposit!");return}try{f(s);const{error:l}=await m.from("lesson_bookings").update({status:"cancelled"}).eq("id",s);if(l){console.error("Error cancelling lesson:",l),c.error("Σφάλμα κατά την ακύρωση του μαθήματος");return}console.log("[PaspartuTraining] Booking cancelled - checking if trigger updated deposit..."),await new Promise(t=>setTimeout(t,1e3));const{data:o,error:d}=await m.from("lesson_deposits").select("*").eq("user_id",a==null?void 0:a.id).single();if(d)console.error("[PaspartuTraining] Error checking deposit after cancellation:",d);else if(console.log("[PaspartuTraining] Deposit check after cancellation:",{total:o.total_lessons,used:o.used_lessons,remaining:o.remaining_lessons}),o.used_lessons===i.usedLessons){console.warn("[PaspartuTraining] ⚠️ TRIGGER NOT WORKING! Applying manual update...");const t=Math.max(i.usedLessons-1,0),{data:u,error:r}=await m.rpc("update_lesson_deposit_manual",{p_user_id:a==null?void 0:a.id,p_used_lessons:t});r?(console.error("[PaspartuTraining] Manual update failed:",r),c.error("Σφάλμα ενημέρωσης deposit. Επικοινωνήστε με τον διαχειριστή.")):console.log("[PaspartuTraining] ✅ Manual update applied successfully")}else console.log("[PaspartuTraining] ✅ TRIGGER WORKING! Deposit updated automatically");console.log("[PaspartuTraining] Booking cancelled successfully, reloading data..."),c.success("Ακυρώσατε επιτυχώς το μάθημα! Το μάθημα επέστρεψε στο deposit σας."),await b()}catch(l){console.error("Error cancelling lesson:",l),c.error("Σφάλμα κατά την ακύρωση του μαθήματος")}finally{f(null)}},_=async s=>{if(console.log("[PaspartuTraining] ===== HANDLING BOOK LESSON ====="),console.log("[PaspartuTraining] Slot:",s),console.log("[PaspartuTraining] Deposit:",i),console.log("[PaspartuTraining] Schedule:",g),!i||i.remainingLessons<=0){console.log("[PaspartuTraining] No deposit or no remaining lessons"),c.error("Δεν έχετε διαθέσιμα μαθήματα!");return}if(!g){console.log("[PaspartuTraining] No schedule found"),c.error("Δεν βρέθηκε πρόγραμμα!");return}try{f(s.sessionId);const l={user_id:a==null?void 0:a.id,schedule_id:g.id,session_id:s.sessionId,booking_date:s.date,booking_time:s.startTime,trainer_name:s.trainer,room:s.room,status:"booked"};console.log("[PaspartuTraining] Creating booking with payload:",l);const{data:o,error:d}=await m.from("lesson_bookings").insert(l).select().single();if(console.log("[PaspartuTraining] Booking result - data:",o,"error:",d),d){console.error("Error booking lesson:",d),c.error("Σφάλμα κατά την κράτηση του μαθήματος");return}console.log("[PaspartuTraining] Booking created successfully - checking if trigger updated deposit..."),await new Promise(r=>setTimeout(r,1e3));const{data:t,error:u}=await m.from("lesson_deposits").select("*").eq("user_id",a==null?void 0:a.id).single();if(u)console.error("[PaspartuTraining] Error checking deposit after booking:",u);else if(console.log("[PaspartuTraining] Deposit check after booking:",{total:t.total_lessons,used:t.used_lessons,remaining:t.remaining_lessons}),t.used_lessons===i.usedLessons){console.warn("[PaspartuTraining] ⚠️ TRIGGER NOT WORKING! Applying manual update...");const{data:r,error:n}=await m.rpc("update_lesson_deposit_manual",{p_user_id:a==null?void 0:a.id,p_used_lessons:i.usedLessons+1});n?(console.error("[PaspartuTraining] Manual update failed:",n),c.error("Σφάλμα ενημέρωσης deposit. Επικοινωνήστε με τον διαχειριστή.")):console.log("[PaspartuTraining] ✅ Manual update applied successfully")}else console.log("[PaspartuTraining] ✅ TRIGGER WORKING! Deposit updated automatically");console.log("[PaspartuTraining] Booking created successfully, reloading data..."),c.success(`Κρατήσατε επιτυχώς το μάθημα στις ${new Date(s.date).toLocaleDateString("el-GR")} στις ${s.startTime}! Το μάθημα αφαιρέθηκε από το deposit σας.`),await b()}catch(l){console.error("Error booking lesson:",l),c.error("Σφάλμα κατά την κράτηση του μαθήματος")}finally{f(null)}},C=s=>{switch(s){case"personal":return e.jsx(k,{className:"h-5 w-5 text-blue-600"});case"kickboxing":return e.jsx(F,{className:"h-5 w-5 text-red-600"});case"combo":return e.jsx(K,{className:"h-5 w-5 text-green-600"});default:return e.jsx(k,{className:"h-5 w-5 text-gray-600"})}},G=s=>{switch(s){case"personal":return"Personal Training";case"kickboxing":return"Kick Boxing";case"combo":return"Combo Training";default:return s}};return S?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Φόρτωση προγράμματος Paspartu..."})]})}):g?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"🎯 Paspartu Training"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[L[g.month-1]," ",g.year]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-6 w-6 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Ενεργό Πρόγραμμα"})]})})]})}),i&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(U,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900",children:"Υπόλοιπο Μαθημάτων"}),e.jsx("p",{className:"text-blue-700",children:"Διαθέσιμα μαθήματα για κράτηση"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-3xl font-bold text-blue-900",children:i.remainingLessons}),e.jsxs("div",{className:"text-sm text-blue-600",children:["από ",i.totalLessons," συνολικά"]})]})]}),i.remainingLessons===0&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{className:"h-5 w-5 text-yellow-600"}),e.jsx("span",{className:"text-yellow-800 font-medium",children:"Δεν έχετε διαθέσιμα μαθήματα. Επικοινωνήστε με τον διαχειριστή για επαναφόρτωση."})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"📅 Διαθέσιμες Ώρες"}),j.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(N,{className:"h-12 w-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{children:"Δεν υπάρχουν διαθέσιμες ώρες"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:j.map(s=>e.jsx("div",{className:`border rounded-lg p-4 transition-all duration-200 ${s.isBooked?"border-green-200 bg-green-50":i&&i.remainingLessons>0?"border-blue-200 bg-white hover:border-blue-300 hover:shadow-md cursor-pointer":"border-gray-200 bg-gray-50 cursor-not-allowed"}`,onClick:()=>{!s.isBooked&&i&&i.remainingLessons>0&&_(s)},children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[C(s.type),e.jsx("h4",{className:"font-medium text-gray-900",children:G(s.type)})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString("el-GR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.startTime," - ",s.endTime]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{children:s.trainer})]}),s.room&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:"📍"}),e.jsx("span",{children:s.room})]})]})]}),e.jsx("div",{className:"ml-4",children:s.isBooked?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-5 w-5 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Κρατημένο"}),s.bookingId&&e.jsx("button",{onClick:l=>{l.stopPropagation(),B(s.bookingId)},disabled:h===s.bookingId,className:"px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors disabled:opacity-50",children:h===s.bookingId?"Ακύρωση...":"Ακύρωση"})]}):i&&i.remainingLessons>0?e.jsx("button",{onClick:l=>{l.stopPropagation(),_(s)},disabled:h===s.sessionId,className:"px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:h===s.sessionId?"Κράτηση...":"Κράτηση"}):e.jsx("span",{className:"text-sm text-gray-500",children:"Μη διαθέσιμο"})})]})},s.sessionId))})]}),x.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"📋 Οι Κρατήσεις μου"}),e.jsx("div",{className:"space-y-4",children:x.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(N,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-medium text-gray-900",children:new Date(s.bookingDate).toLocaleDateString("el-GR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsx("span",{children:s.bookingTime})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{children:s.trainerName})]}),s.room&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:"📍"}),e.jsx("span",{children:s.room})]})]})]})})},s.id))})]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Δεν βρέθηκε πρόγραμμα Paspartu"}),e.jsx("p",{className:"text-gray-600",children:"Δεν υπάρχει διαθέσιμο πρόγραμμα Paspartu Training για εσάς."})]})})};export{z as default};
