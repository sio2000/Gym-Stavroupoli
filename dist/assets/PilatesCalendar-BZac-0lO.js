import{u as G,r as d,j as e,x as H,b as K,v as k,F as c,e as B}from"./index-TtR70Vtr.js";import{s as X,a as Z,c as q,d as J,e as Q,f as V}from"./pilatesScheduleApi-CD458hc6.js";import{t as u,a as W}from"./date-C5fJ6Q3j.js";import{C as Y,a as ee}from"./chevron-right-o-S51X4p.js";const oe=()=>{const{user:a}=G(),[w,A]=d.useState([]),[P,$]=d.useState([]),[z,D]=d.useState(!0),[j,E]=d.useState(0),[l,S]=d.useState(()=>{const s=new Date("2025-09-13T00:00:00.000Z");return console.log("User: Using admin week - 13 Sep:",s.toISOString()),s}),L=()=>{const s=[],t=new Date(l);console.log("User: getWeekDates - currentWeek:",t);for(let r=0;r<14;r++){const n=W(t,r);s.push(n),console.log(`User: Day ${r}: ${u(n)}`)}return s},T=()=>{const s=[];for(let t=8;t<=21;t++)s.push(`${t.toString().padStart(2,"0")}:00`);return s},y=s=>{const t=["Κυρ","Δευ","Τρι","Τετ","Πεμ","Παρ","Σαβ"],r=["Ιαν","Φεβ","Μαρ","Απρ","Μαι","Ιουν","Ιουλ","Αυγ","Σεπ","Οκτ","Νοε","Δεκ"],n=t[s.getDay()],i=s.getDate(),x=r[s.getMonth()];return`${n} ${i} ${x}`},F=s=>{const t=s.getDay();return t===0||t===6},U=(s,t)=>w.filter(r=>r.date===s&&r.start_time===t+":00"),O=(s,t)=>w.some(r=>r.date===s&&r.start_time===t+":00"),C=s=>P.some(t=>t.slot_id===s&&t.status==="confirmed"),b=async()=>{if(a!=null&&a.id)try{D(!0),console.log("=== LOADING PILATES CALENDAR DATA ===");const s=u(new Date(l)),t=u(W(new Date(l),13)),[r,n,i]=await Promise.all([Z(s,t),q(a.id),J(a.id)]);console.log("Fetched slots from DB:",r.length),console.log("Fetched bookings from DB:",n.length);const x=r.map(o=>({...o,available_capacity:Math.max(0,o.max_capacity-o.booked_count)}));A(x),$(n),E((i==null?void 0:i.deposit_remaining)||0)}catch(s){console.error("Error loading data:",s),c.error("Σφάλμα φόρτωσης δεδομένων")}finally{D(!1)}},_=s=>{const t=new Date(l);s==="prev"?t.setDate(t.getDate()-14):t.setDate(t.getDate()+14),S(t),console.log("Navigated to week:",t)},I=async s=>{if(a!=null&&a.id){if(!s.is_active){c.error("Αυτό το μάθημα δεν είναι διαθέσιμο.");return}if(C(s.id)){c.error("Έχετε ήδη κλείσει αυτό το μάθημα.");return}try{if(console.log("Booking slot:",s),j<=0){c.error("Τα μαθήματά σας τελείωσαν. Για ανανέωση, απευθυνθείτε στη ρεσεψιόν.");return}if(s.booked_count>=s.max_capacity){c.error("Το μάθημα είναι πλήρες.");return}const t=await Q({slotId:s.id,notes:""},a.id);console.log("Booking created:",t),c.success("Το μάθημα κλείστηκε επιτυχώς!"),await b()}catch(t){console.error("Error booking slot:",t),c.error("Σφάλμα κατά την κράτηση του μαθήματος.")}}},R=async s=>{if(a!=null&&a.id)try{console.log("Cancelling booking for slot:",s),await V(s),c.success("Η κράτηση ακυρώθηκε επιτυχώς!"),await b()}catch(t){console.error("Error cancelling booking:",t),c.error("Σφάλμα κατά την ακύρωση της κράτησης.")}};d.useEffect(()=>{console.log("User: useEffect triggered - currentWeek changed to:",l.toISOString()),b();const s=X(()=>{b()});return()=>{try{s.unsubscribe()}catch{}}},[a==null?void 0:a.id,l]);const p=L(),M=T();return z?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{className:"animate-spin text-primary mx-auto mb-4",size:48}),e.jsx("p",{className:"text-lg text-gray-600",children:"Φόρτωση προγράμματος..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6 mb-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-800 flex items-center",children:[e.jsx(K,{className:"mr-3 text-primary",size:32}),"Ημερολόγιο Pilates"]}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Κλείστε μαθήματα pilates για τις επόμενες 2 εβδομάδες"})]})}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>_("prev"),className:"flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",children:[e.jsx(Y,{size:20,className:"mr-2"}),"Προηγούμενη"]}),e.jsx("button",{onClick:()=>{const s=new Date,t=s.getDay(),r=new Date(s),n=t===0?-6:1-t;r.setDate(s.getDate()+n),r.setHours(0,0,0,0),S(r),console.log("User: Force refreshed currentWeek to:",r.toISOString())},className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"🔄 Refresh"})]}),e.jsx("div",{className:"text-center",children:e.jsxs("h2",{className:"text-xl font-semibold text-gray-800",children:["2 εβδομάδες: ",y(p[0])," - ",y(p[13])]})}),e.jsxs("button",{onClick:()=>_("next"),className:"flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",children:["Επόμενη",e.jsx(ee,{size:20,className:"ml-2"})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:e.jsxs("p",{className:"text-blue-800 text-sm",children:[e.jsx("strong",{children:"Οδηγίες:"})," Κάντε κλικ στα πράσινα μαθήματα για να κλείσετε κράτηση. Τα κόκκινα μαθήματα είναι ακυρωμένα από τον admin. Τα μπλε μαθήματα είναι ήδη κρατημένα από εσάς."]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 mb-4 border",children:[e.jsxs("p",{className:"text-lg font-semibold",children:["Pilates deposit: ",j," μαθήματα απομένουν"]}),j<=0&&e.jsx("p",{className:"text-red-600 mt-1",children:"Τα μαθήματά σας τελείωσαν. Για ανανέωση, απευθυνθείτε στη ρεσεψιόν."})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b",children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 w-20",children:"Ώρα"}),p.map(s=>e.jsx("th",{className:"px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-32",children:y(s)},u(s)))]})}),e.jsx("tbody",{children:M.map(s=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-700",children:s}),p.map(t=>{const r=u(t),n=U(r,s),i=F(t),x=O(r,s);return e.jsx("td",{className:"px-4 py-3 text-center",children:i?e.jsx("div",{className:"text-gray-400 text-xs",children:"Σαβ/Κυρ"}):x?e.jsx("div",{className:"space-y-1",children:n.map(o=>{const f=C(o.id),N=o.is_active,v=o.booked_count>=o.max_capacity;let m="",g=null,h="";return f?(m="bg-blue-100 text-blue-800 border-blue-200",g=e.jsx(B,{size:16,className:"text-blue-600"}),h="Κρατημένο"):N&&!v?(m="bg-green-100 text-green-800 border-green-200 hover:bg-green-200 cursor-pointer",g=e.jsx(B,{size:16,className:"text-green-600"}),h=`${o.booked_count}/${o.max_capacity}`):N&&v?(m="bg-red-100 text-red-800 border-red-200 cursor-not-allowed",g=e.jsx(k,{size:16,className:"text-red-600"}),h="Πλήρες"):(m="bg-red-100 text-red-800 border-red-200 cursor-not-allowed",g=e.jsx(k,{size:16,className:"text-red-600"}),h="Ακυρωμένο"),e.jsx("div",{className:`px-3 py-2 rounded-lg border text-xs font-medium transition-colors ${m}`,onClick:()=>{N&&!f&&!v?I(o):f&&R(o.id)},children:e.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[g,e.jsx("span",{children:h})]})},o.id)})}):e.jsx("div",{className:"bg-red-100 text-red-800 border-red-200 px-3 py-2 rounded-lg text-xs font-medium cursor-not-allowed",children:e.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[e.jsx(k,{size:16,className:"text-red-600"}),e.jsx("span",{children:"Μη διαθέσιμο"})]})})},`${r}-${s}`)})]},s))})]})})}),e.jsxs("div",{className:"mt-6 bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Εξήγηση χρωμάτων"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-green-100 border border-green-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Διαθέσιμο για κράτηση"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-100 border border-blue-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Κρατημένο από εσάς"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-red-100 border border-red-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Πλήρες/Ακυρωμένο"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-4 h-4 bg-red-100 border border-red-200 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Μη διαθέσιμο"})]})]})]})]})})};export{oe as default};
