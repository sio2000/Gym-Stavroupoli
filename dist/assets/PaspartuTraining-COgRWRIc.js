import{u as R,r as u,s as x,z as g,j as e,e as T,h as O,m as U,b as h,C as w,U as v,D as P,w as q}from"./index-D6Gv1okz.js";import{B as K}from"./book-open-GZAVF5J5.js";import{Z as $}from"./zap-DaQkCScu.js";const M=()=>{const{user:r}=R(),[m,k]=u.useState(null),[i,D]=u.useState(null),[p,S]=u.useState([]),[b,I]=u.useState([]),[L,f]=u.useState(!0),[j,N]=u.useState(null),A=["Κυριακή","Δευτέρα","Τρίτη","Τετάρτη","Πέμπτη","Παρασκευή","Σάββατο"];u.useEffect(()=>{r!=null&&r.id&&y()},[r==null?void 0:r.id]);const y=async()=>{try{console.log("[PaspartuTraining] ===== LOADING PASPARTU DATA ====="),console.log("[PaspartuTraining] User ID:",r==null?void 0:r.id),f(!0),console.log("[PaspartuTraining] Querying personal_training_schedules...");const{data:s,error:l}=await x.from("personal_training_schedules").select("*").eq("user_id",r==null?void 0:r.id).order("created_at",{ascending:!1});if(console.log("[PaspartuTraining] All schedules for user:",s),console.log("[PaspartuTraining] All schedules error:",l),s&&s.length>0){console.log("[PaspartuTraining] Found schedules, checking for Paspartu...");const a=s.find(t=>t.user_type==="paspartu"&&t.is_flexible===!0);if(a){console.log("[PaspartuTraining] Found Paspartu schedule:",a);const t={id:a.id,userId:a.user_id,month:a.month,year:a.year,scheduleData:a.schedule_data,status:a.status,createdBy:a.created_by,createdAt:a.created_at,updatedAt:a.updated_at,acceptedAt:a.accepted_at,declinedAt:a.declined_at,userType:a.user_type,isFlexible:a.is_flexible};k(t)}else console.log("[PaspartuTraining] No Paspartu schedule found in user schedules"),s.forEach((t,G)=>{console.log(`[PaspartuTraining] Schedule ${G}:`,{id:t.id,user_type:t.user_type,is_flexible:t.is_flexible,status:t.status})})}else console.log("[PaspartuTraining] No schedules found for user");console.log("[PaspartuTraining] Querying lesson_deposits...");const{data:o,error:d}=await x.from("lesson_deposits").select("*").eq("user_id",r==null?void 0:r.id).single();if(console.log("[PaspartuTraining] Deposit data:",o),console.log("[PaspartuTraining] Deposit error:",d),d)console.error("Error loading lesson deposit:",d);else if(o){const a={id:o.id,userId:o.user_id,totalLessons:o.total_lessons,usedLessons:o.used_lessons,remainingLessons:o.remaining_lessons,createdAt:o.created_at,updatedAt:o.updated_at,createdBy:o.created_by};console.log("[PaspartuTraining] Setting deposit:",a),D(a)}console.log("[PaspartuTraining] Querying lesson_bookings...");const{data:n,error:c}=await x.from("lesson_bookings").select("*").eq("user_id",r==null?void 0:r.id).order("booking_date",{ascending:!0});if(console.log("[PaspartuTraining] Bookings data:",n),console.log("[PaspartuTraining] Bookings error:",c),c)console.error("Error loading lesson bookings:",c);else if(n){const a=n.map(t=>({id:t.id,userId:t.user_id,scheduleId:t.schedule_id,sessionId:t.session_id,bookingDate:t.booking_date,bookingTime:t.booking_time,trainerName:t.trainer_name,room:t.room,notes:t.notes,status:t.status,createdAt:t.created_at,updatedAt:t.updated_at}));console.log("[PaspartuTraining] Setting bookings:",a),S(a)}}catch(s){console.error("Error loading Paspartu data:",s),g.error("Σφάλμα κατά τη φόρτωση των δεδομένων")}finally{f(!1)}},E=s=>{var d;if(!((d=s==null?void 0:s.scheduleData)!=null&&d.sessions))return[];const l=[],o=new Set(p.map(n=>n.sessionId));return s.scheduleData.sessions.forEach(n=>{const c=o.has(n.id),a=p.find(t=>t.sessionId===n.id);l.push({sessionId:n.id,date:n.date,startTime:n.startTime,endTime:n.endTime,type:n.type,trainer:n.trainer,room:n.room,isBooked:c,bookingId:a==null?void 0:a.id})}),l.sort((n,c)=>new Date(n.date).getTime()-new Date(c.date).getTime())};u.useEffect(()=>{if(m){const s=E(m);I(s)}},[m,p]);const _=async s=>{if(console.log("[PaspartuTraining] ===== HANDLING BOOK LESSON ====="),console.log("[PaspartuTraining] Slot:",s),console.log("[PaspartuTraining] Deposit:",i),console.log("[PaspartuTraining] Schedule:",m),!i||i.remainingLessons<=0){console.log("[PaspartuTraining] No deposit or no remaining lessons"),g.error("Δεν έχετε διαθέσιμα μαθήματα!");return}if(!m){console.log("[PaspartuTraining] No schedule found"),g.error("Δεν βρέθηκε πρόγραμμα!");return}try{N(s.sessionId);const l={user_id:r==null?void 0:r.id,schedule_id:m.id,session_id:s.sessionId,booking_date:s.date,booking_time:s.startTime,trainer_name:s.trainer,room:s.room,status:"booked"};console.log("[PaspartuTraining] Creating booking with payload:",l);const{data:o,error:d}=await x.from("lesson_bookings").insert(l).select().single();if(console.log("[PaspartuTraining] Booking result - data:",o,"error:",d),d){console.error("Error booking lesson:",d),g.error("Σφάλμα κατά την κράτηση του μαθήματος");return}console.log("[PaspartuTraining] Booking created successfully - checking if trigger updated deposit..."),await new Promise(a=>setTimeout(a,1e3));const{data:n,error:c}=await x.from("lesson_deposits").select("*").eq("user_id",r==null?void 0:r.id).single();if(c)console.error("[PaspartuTraining] Error checking deposit after booking:",c);else if(console.log("[PaspartuTraining] Deposit check after booking:",{total:n.total_lessons,used:n.used_lessons,remaining:n.remaining_lessons}),n.used_lessons===i.usedLessons){console.warn("[PaspartuTraining] ⚠️ TRIGGER NOT WORKING! Applying manual update...");const{data:a,error:t}=await x.rpc("update_lesson_deposit_manual",{p_user_id:r==null?void 0:r.id,p_used_lessons:i.usedLessons+1});t?(console.error("[PaspartuTraining] Manual update failed:",t),g.error("Σφάλμα ενημέρωσης deposit. Επικοινωνήστε με τον διαχειριστή.")):console.log("[PaspartuTraining] ✅ Manual update applied successfully")}else console.log("[PaspartuTraining] ✅ TRIGGER WORKING! Deposit updated automatically");console.log("[PaspartuTraining] Booking created successfully, reloading data..."),g.success(`Κρατήσατε επιτυχώς το μάθημα στις ${new Date(s.date).toLocaleDateString("el-GR")} στις ${s.startTime}! Το μάθημα αφαιρέθηκε από το deposit σας.`),await y()}catch(l){console.error("Error booking lesson:",l),g.error("Σφάλμα κατά την κράτηση του μαθήματος")}finally{N(null)}},B=s=>{switch(s){case"personal":return e.jsx(P,{className:"h-5 w-5 text-blue-600"});case"kickboxing":return e.jsx($,{className:"h-5 w-5 text-red-600"});case"combo":return e.jsx(q,{className:"h-5 w-5 text-green-600"});default:return e.jsx(P,{className:"h-5 w-5 text-gray-600"})}},C=s=>{switch(s){case"personal":return"Personal Training";case"kickboxing":return"Kick Boxing";case"combo":return"Combo Training";default:return s}};return L?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Φόρτωση προγράμματος Paspartu..."})]})}):m?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"🎯 Paspartu Training"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:[A[m.month-1]," ",m.year]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-6 w-6 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Ενεργό Πρόγραμμα"})]})})]})}),i&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(O,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900",children:"Υπόλοιπο Μαθημάτων"}),e.jsx("p",{className:"text-blue-700",children:"Διαθέσιμα μαθήματα για κράτηση"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-3xl font-bold text-blue-900",children:i.remainingLessons}),e.jsxs("div",{className:"text-sm text-blue-600",children:["από ",i.totalLessons," συνολικά"]})]})]}),i.remainingLessons===0&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:"h-5 w-5 text-yellow-600"}),e.jsx("span",{className:"text-yellow-800 font-medium",children:"Δεν έχετε διαθέσιμα μαθήματα. Επικοινωνήστε με τον διαχειριστή για επαναφόρτωση."})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"📅 Διαθέσιμες Ώρες"}),b.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(h,{className:"h-12 w-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{children:"Δεν υπάρχουν διαθέσιμες ώρες"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:b.map(s=>e.jsx("div",{className:`border rounded-lg p-4 transition-all duration-200 ${s.isBooked?"border-green-200 bg-green-50":i&&i.remainingLessons>0?"border-blue-200 bg-white hover:border-blue-300 hover:shadow-md cursor-pointer":"border-gray-200 bg-gray-50 cursor-not-allowed"}`,onClick:()=>{!s.isBooked&&i&&i.remainingLessons>0&&_(s)},children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[B(s.type),e.jsx("h4",{className:"font-medium text-gray-900",children:C(s.type)})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString("el-GR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsxs("span",{children:[s.startTime," - ",s.endTime]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx("span",{children:s.trainer})]}),s.room&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:"📍"}),e.jsx("span",{children:s.room})]})]})]}),e.jsx("div",{className:"ml-4",children:s.isBooked?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"h-5 w-5 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Κρατημένο"})]}):i&&i.remainingLessons>0?e.jsx("button",{onClick:l=>{l.stopPropagation(),_(s)},disabled:j===s.sessionId,className:"px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:j===s.sessionId?"Κράτηση...":"Κράτηση"}):e.jsx("span",{className:"text-sm text-gray-500",children:"Μη διαθέσιμο"})})]})},s.sessionId))})]}),p.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"📋 Οι Κρατήσεις μου"}),e.jsx("div",{className:"space-y-4",children:p.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(h,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-medium text-gray-900",children:new Date(s.bookingDate).toLocaleDateString("el-GR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsx("span",{children:s.bookingTime})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx("span",{children:s.trainerName})]}),s.room&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:"📍"}),e.jsx("span",{children:s.room})]})]})]})})},s.id))})]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(K,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Δεν βρέθηκε πρόγραμμα Paspartu"}),e.jsx("p",{className:"text-gray-600",children:"Δεν υπάρχει διαθέσιμο πρόγραμμα Paspartu Training για εσάς."})]})})};export{M as default};
